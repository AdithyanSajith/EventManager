<% if @events.any? %>
  <% @events.each do |event| %>
    <% participant = current_resource_owner.userable %>
    <% registration = participant ? Registration.find_by(participant_id: participant.id, event_id: event.id) : nil %>
    <% ticket = registration&.ticket %>
    <% payment = registration&.payment %>
    <% reviews = event.reviews.includes(:participant).order(created_at: :desc) %>

    <div class="card shadow-sm mb-4">
      <div class="card-body" data-controller="payment" data-payment-event-id="<%= event.id %>">
        <h5 class="card-title"><%= event.title %></h5>
        <p class="card-text"><%= event.description %></p>

        <p class="card-text">
          <strong>Starts At:</strong> <%= event.starts_at.strftime("%B %d, %Y %I:%M %p") %><br>
          <strong>Ends At:</strong> <%= event.ends_at.strftime("%B %d, %Y %I:%M %p") %>
        </p>

        <% if event.venue.present? %>
          <p class="card-text"><strong>Location:</strong> <%= event.venue.name %></p>
        <% end %>

        <% if ticket.present? %>
          <p class="text-success">üéüÔ∏è Ticket ID: <%= ticket.id %></p>
          <%= link_to "View Ticket", ticket_path(ticket), class: "btn btn-outline-success btn-sm me-2" %>
          <%= link_to "Add Review", new_event_review_path(event), class: "btn btn-outline-primary btn-sm" %>
        <% else %>
          <!-- Payment button managed by Stimulus -->
          <button data-payment-target="button" data-action="click->payment#pay" class="btn btn-warning btn-sm" style="display:none;">
            Pay Now
          </button>
        <% end %>

        <!-- Async status from Stimulus -->
        <div class="mt-2">
          <span data-payment-target="status" class="badge bg-info-subtle text-dark">
            Checking status...
          </span>
        </div>

        <% if reviews.any? %>
          <hr>
          <h6 class="mt-4">Reviews:</h6>
          <% reviews.each do |review| %>
            <div class="border rounded p-2 mb-2 bg-white">
              <strong><%= review.participant&.name || "Anonymous" %></strong> -
              <span class="text-muted"><%= review.created_at.strftime("%d %b %Y") %></span><br>
              ‚≠ê <strong><%= review.rating %>/5</strong><br>
              <%= review.comment %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted mt-3">No reviews yet.</p>
        <% end %>
      </div>
    </div>
  <% end %>
<% else %>
  <p>No events found.</p>
<% end %>
